<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบจัดการงานออฟฟิศ</title>
  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <div id="app" class="max-w-5xl mx-auto p-4">
    <!-- App header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">ระบบจัดการงานออฟฟิศ</h1>
      <div id="header-right"></div>
    </header>

    <main id="main"></main>
  </div>

  <template id="login-template">
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-medium mb-4">เข้าสู่ระบบ</h2>
      <div class="mb-3">
        <label class="block text-sm">ชื่อผู้ใช้</label>
        <input id="login-username" class="w-full mt-1 p-2 border rounded" />
      </div>
      <div class="mb-4">
        <label class="block text-sm">รหัสผ่าน</label>
        <input id="login-password" type="password" class="w-full mt-1 p-2 border rounded" />
      </div>
      <div class="flex gap-2">
        <button id="btn-login" class="px-4 py-2 bg-sky-600 text-white rounded">เข้าสู่ระบบ</button>
        <button id="btn-sample-data" class="px-4 py-2 border rounded">สร้างตัวอย่าง (local)</button>
      </div>
      <p class="text-sm text-slate-500 mt-3">ใช้บัญชีตัวอย่าง: admin / admin123 (role: Admin), user1 / user123 (role: User)</p>
    </div>
  </template>

  <template id="admin-dashboard-template">
    <div>
      <div class="flex gap-4 mb-6">
        <div class="flex-1 bg-white p-4 rounded shadow">
          <h3 class="font-semibold">มอบหมายงานใหม่</h3>
          <div class="mt-3">
            <label class="block text-sm">ชื่องาน</label>
            <input id="task-title" class="w-full mt-1 p-2 border rounded" />
            <label class="block text-sm mt-2">คำอธิบาย</label>
            <textarea id="task-desc" class="w-full mt-1 p-2 border rounded"></textarea>
            <div class="mt-2 grid grid-cols-2 gap-2">
              <div>
                <label class="block text-sm">กำหนดส่ง</label>
                <input id="task-due" type="date" class="w-full mt-1 p-2 border rounded" />
              </div>
              <div>
                <label class="block text-sm">ผู้รับผิดชอบ</label>
                <select id="task-assignee" class="w-full mt-1 p-2 border rounded"></select>
              </div>
            </div>
            <div class="mt-3">
              <button id="btn-create-task" class="px-4 py-2 bg-green-600 text-white rounded">มอบหมายงาน</button>
            </div>
          </div>
        </div>

        <div class="w-80 bg-white p-4 rounded shadow">
          <h3 class="font-semibold">รายงานสรุป</h3>
          <div id="report-box" class="mt-3 text-sm space-y-2"></div>
          <div class="mt-4">
            <button id="btn-refresh-report" class="px-3 py-1 border rounded">รีเฟรช</button>
          </div>
        </div>
      </div>

      <section class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">รายการงานทั้งหมด</h3>
        <div id="tasks-list" class="space-y-3"></div>
      </section>
    </div>
  </template>

  <template id="user-dashboard-template">
    <div>
      <div class="mb-6 grid md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold">งานของฉัน</h3>
          <div id="my-tasks" class="mt-3 space-y-3"></div>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold">สถานะ & สรุป</h3>
          <div id="user-report" class="mt-3 text-sm"></div>
        </div>
      </div>

      <section class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold">ประวัติการส่งงาน</h3>
        <div id="submissions-list" class="mt-3 space-y-3"></div>
      </section>
    </div>
  </template>

  <!-- Modal placeholder -->
  <div id="modal-root"></div>

<script>
/*
  Frontend SPA (Vanilla JS) that talks to Google Apps Script backend.
  IMPORTANT: set GAS_WEB_APP_URL to your deployed Apps Script Web App URL.
*/
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyRb67ake-nczre-k5t1t-G9lk3K1L16zRFYgb4OViO28a9P8-_TzDZM5DQ1-p26Cf5GA/exec"; // <- แก้ที่นี่

/* ---------- small helpers ---------- */
function el(id) { return document.getElementById(id); }
function q(selector) { return document.querySelector(selector); }
function showToast(msg, type='info') {
  alert(msg);
}

/* ---------- State ---------- */
let state = {
  token: localStorage.getItem('task_app_token') || null,
  user: JSON.parse(localStorage.getItem('task_app_user') || 'null'),
  users: []
};

/* ---------- Auth / requests ---------- */
async function api(action, body = {}) {
  const url = GAS_WEB_APP_URL;
  body.action = action;
  const headers = {'Content-Type': 'application/json'};
  if (state.token) headers['X-Auth-Token'] = state.token;
  const resp = await fetch(url, {
    method: 'POST',
    headers,
    body: JSON.stringify(body)
  });
  const data = await resp.json();
  if (!resp.ok && data && data.error) throw new Error(data.error);
  return data;
}

/* ---------- Renderers ---------- */
function renderHeader() {
  const hr = el('header-right');
  hr.innerHTML = '';
  if (!state.user) {
    const btn = document.createElement('button');
    btn.textContent = 'เข้าสู่ระบบ';
    btn.className = 'px-3 py-2 bg-sky-600 text-white rounded';
    btn.onclick = () => initLogin();
    hr.appendChild(btn);
  } else {
    const span = document.createElement('div');
    span.className = 'flex items-center gap-3';
    span.innerHTML = `<div class="text-sm">สวัสดี, <strong>${state.user.fullName}</strong> (${state.user.role})</div>`;
    const btnLogout = document.createElement('button');
    btnLogout.className = 'px-3 py-2 border rounded';
    btnLogout.textContent = 'ออกจากระบบ';
    btnLogout.onclick = logout;
    span.appendChild(btnLogout);
    hr.appendChild(span);
  }
}

function initApp() {
  renderHeader();
  if (!state.user) {
    initLogin();
  } else {
    if (state.user.role === 'Admin') initAdminDashboard();
    else initUserDashboard();
  }
}

/* ---------- Login ---------- */
function initLogin() {
  const tpl = document.getElementById('login-template').content.cloneNode(true);
  el('main').innerHTML = '';
  el('main').appendChild(tpl);
  el('btn-login').onclick = async () => {
    const username = el('login-username').value.trim();
    const password = el('login-password').value.trim();
    if (!username || !password) { showToast('กรุณากรอกข้อมูล'); return; }
    try {
      const res = await api('login', {username, password});
      state.token = res.token;
      state.user = res.user;
      localStorage.setItem('task_app_token', state.token);
      localStorage.setItem('task_app_user', JSON.stringify(state.user));
      renderHeader();
      initApp();
    } catch (e) {
      showToast('ไม่สามารถเข้าสู่ระบบ: ' + e.message);
    }
  };

  // Local sample data filler (for quick demo without backend auth)
  el('btn-sample-data').onclick = () => {
    // set sample user (local-only)
    state.user = {username:'admin', fullName:'Admin', role:'Admin'};
    localStorage.setItem('task_app_user', JSON.stringify(state.user));
    renderHeader();
    initApp();
  };
}

/* ---------- Admin Dashboard ---------- */
async function initAdminDashboard() {
  const tpl = document.getElementById('admin-dashboard-template').content.cloneNode(true);
  el('main').innerHTML = '';
  el('main').appendChild(tpl);
  // populate assignee list
  try {
    const list = await api('getUsers');
    state.users = list.users;
    const sel = el('task-assignee');
    sel.innerHTML = '<option value="">--เลือกผู้รับผิดชอบ--</option>';
    state.users.filter(u=>u.role!=='Admin').forEach(u=>{
      const o = document.createElement('option'); o.value = u.username; o.textContent = `${u.fullName} (${u.username})`; sel.appendChild(o);
    });
  } catch (e) { showToast('ไม่สามารถดึงผู้ใช้: ' + e.message); }

  el('btn-create-task').onclick = async () => {
    const title = el('task-title').value.trim();
    const desc = el('task-desc').value.trim();
    const due = el('task-due').value;
    const assignee = el('task-assignee').value;
    if (!title || !assignee) { showToast('กรอกข้อมูลให้ครบ'); return; }
    try {
      await api('createTask',{title,desc,due,assignee});
      showToast('มอบหมายงานเรียบร้อย');
      el('task-title').value = el('task-desc').value = ''; el('task-due').value = ''; el('task-assignee').value = '';
      loadAllTasks();
      loadReport();
    } catch (e) { showToast('ผิดพลาด: '+e.message); }
  };

  el('btn-refresh-report').onclick = loadReport;

  loadAllTasks();
  loadReport();
}

async function loadAllTasks() {
  try {
    const res = await api('getTasks', {scope:'all'});
    const container = el('tasks-list');
    container.innerHTML = '';
    res.tasks.forEach(t => {
      const card = document.createElement('div');
      card.className = 'p-3 border rounded flex justify-between items-start';
      card.innerHTML = `
        <div>
          <div class="text-base font-medium">${t.title}</div>
          <div class="text-sm text-slate-600">${t.description || ''}</div>
          <div class="text-xs text-slate-500 mt-1">กำหนดส่ง: ${t.dueDate || '-'} | ผู้รับ: ${t.assignedTo} | สถานะ: <strong>${t.status}</strong></div>
        </div>
        <div class="flex flex-col gap-2">
          <button class="px-2 py-1 border rounded btn-view" data-id="${t.id}">ดู/ตรวจงาน</button>
        </div>
      `;
      container.appendChild(card);
    });

    // attach view buttons
    container.querySelectorAll('.btn-view').forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.dataset.id;
        const res = await api('getTasks',{scope:'byId', id});
        openAdminTaskModal(res.task);
      };
    });

  } catch (e) { showToast('ไม่สามารถโหลดงาน: ' + e.message); }
}

function openAdminTaskModal(task) {
  const modalRoot = el('modal-root');
  modalRoot.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4';
  div.innerHTML = `
    <div class="bg-white w-full max-w-2xl p-5 rounded shadow">
      <div class="flex justify-between items-start">
        <div>
          <h3 class="text-lg font-semibold">${task.title}</h3>
          <div class="text-sm text-slate-600">${task.description || ''}</div>
          <div class="text-xs text-slate-500 mt-2">กำหนดส่ง: ${task.dueDate || '-'} | ผู้รับ: ${task.assignedTo}</div>
        </div>
        <div><button id="close-modal" class="px-2 py-1 border rounded">ปิด</button></div>
      </div>

      <div class="mt-4">
        <h4 class="font-medium">รายละเอียดส่งงาน</h4>
        <div id="submission-area" class="mt-2 text-sm"></div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="btn-approve" class="px-3 py-2 bg-green-600 text-white rounded">อนุมัติ</button>
        <button id="btn-reject" class="px-3 py-2 bg-rose-600 text-white rounded">ไม่อนุมัติ</button>
      </div>
      <div id="reject-comment-box" class="mt-3 hidden">
        <label class="block text-sm">เหตุผลไม่อนุมัติ</label>
        <textarea id="reject-comment" class="w-full mt-1 p-2 border rounded"></textarea>
        <div class="mt-2"><button id="btn-send-reject" class="px-3 py-2 bg-rose-600 text-white rounded">ส่งเหตุผล</button></div>
      </div>
    </div>
  `;
  modalRoot.appendChild(div);
  div.querySelector('#close-modal').onclick = ()=> modalRoot.innerHTML = '';

  // show submission info
  const subArea = div.querySelector('#submission-area');
  if (!task.attachmentUrl) subArea.innerHTML = `<div class="text-sm text-slate-500">ยังไม่มีการส่งงาน</div>`;
  else subArea.innerHTML = `<div>ส่งโดย: ${task.submittedBy || '-'} <br/> <a href="${task.attachmentUrl}" target="_blank" class="text-sky-600 underline">ดูไฟล์แนบ / ลิงก์</a><br/> สถานะ: <strong>${task.status}</strong></div>`;

  // approve
  div.querySelector('#btn-approve').onclick = async () => {
    try {
      await api('reviewTask', {id: task.id, action:'approve'});
      showToast('อนุมัติเรียบร้อย');
      modalRoot.innerHTML = '';
      loadAllTasks(); loadReport();
    } catch (e) { showToast('ผิดพลาด: '+e.message); }
  };

  // reject
  div.querySelector('#btn-reject').onclick = ()=> {
    div.querySelector('#reject-comment-box').classList.remove('hidden');
  };
  div.querySelector('#btn-send-reject').onclick = async () => {
    const comment = div.querySelector('#reject-comment').value.trim();
    if (!comment) { showToast('กรุณากรอกเหตุผล'); return; }
    try {
      await api('reviewTask', {id: task.id, action:'reject', comment});
      showToast('ส่งเหตุผลการไม่อนุมัติเรียบร้อย');
      modalRoot.innerHTML = '';
      loadAllTasks(); loadReport();
    } catch (e) { showToast('ผิดพลาด: '+e.message); }
  };
}

/* ---------- Reports ---------- */
async function loadReport() {
  try {
    const res = await api('getReport');
    const box = el('report-box');
    box.innerHTML = `
      <div>มอบหมายทั้งหมด: <strong>${res.total}</strong></div>
      <div>กำลังดำเนินการ: <strong>${res.inProgress}</strong></div>
      <div>รอตรวจ: <strong>${res.submitted}</strong></div>
      <div>อนุมัติแล้ว: <strong>${res.approved}</strong></div>
      <div class="mt-2 text-xs text-slate-500">สรุปยอดรายเดือน (ระบบคำนวณจากวันที่สร้าง/ส่ง)</div>
    `;
  } catch (e) { showToast('ไม่สามารถดึงรายงาน: '+e.message); }
}

/* ---------- User Dashboard ---------- */
async function initUserDashboard() {
  const tpl = document.getElementById('user-dashboard-template').content.cloneNode(true);
  el('main').innerHTML = '';
  el('main').appendChild(tpl);
  loadUserTasks();
  loadUserReport();
  loadSubmissions();
}

async function loadUserTasks() {
  try {
    const res = await api('getTasks', {scope:'assigned'});
    const container = el('my-tasks');
    container.innerHTML = '';
    res.tasks.forEach(t => {
      const card = document.createElement('div');
      card.className = 'p-3 border rounded flex justify-between items-start';
      card.innerHTML = `
        <div>
          <div class="font-medium">${t.title}</div>
          <div class="text-sm text-slate-600">${t.description || ''}</div>
          <div class="text-xs text-slate-500 mt-1">กำหนดส่ง: ${t.dueDate || '-'} | สถานะ: <strong>${t.status}</strong></div>
        </div>
        <div class="flex flex-col gap-2">
          ${t.status === 'New' ? `<button class="px-2 py-1 border btn-accept" data-id="${t.id}">รับงาน</button>` : ''}
          ${t.status === 'In Progress' || t.status === 'New' ? `<button class="px-2 py-1 border btn-submit" data-id="${t.id}">ส่งงาน</button>` : ''}
          <button class="px-2 py-1 border btn-view" data-id="${t.id}">ดู</button>
        </div>
      `;
      container.appendChild(card);
    });

    container.querySelectorAll('.btn-accept').forEach(b=>{
      b.onclick = async ()=> {
        const id = b.dataset.id;
        await api('acceptTask',{id});
        showToast('รับงานแล้ว');
        loadUserTasks(); loadUserReport();
      };
    });
    container.querySelectorAll('.btn-submit').forEach(b=>{
      b.onclick = ()=> openSubmitModal(b.dataset.id);
    });
    container.querySelectorAll('.btn-view').forEach(b=>{
      b.onclick = async ()=> {
        const id = b.dataset.id;
        const res = await api('getTasks',{scope:'byId', id});
        alert(`งาน: ${res.task.title}\nสถานะ: ${res.task.status}\nคำอธิบาย: ${res.task.description || '-'}`);
      };
    });

  } catch (e) { showToast('ไม่สามารถโหลดงาน: ' + e.message); }
}

function openSubmitModal(taskId) {
  const root = el('modal-root');
  root.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4';
  div.innerHTML = `
    <div class="bg-white w-full max-w-lg p-5 rounded shadow">
      <h3 class="font-semibold mb-2">ส่งงาน</h3>
      <div>
        <label class="block text-sm">ไฟล์ / ลิงก์ (ไฟล์จะอัปโหลดไปยัง Google Drive)</label>
        <input type="file" id="submit-file" class="mt-2" />
        <div class="mt-2">
          <label class="block text-sm">ลิงก์ (ถ้ามี)</label>
          <input id="submit-link" class="w-full mt-1 p-2 border rounded" />
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="btn-send-submit" class="px-3 py-2 bg-sky-600 text-white rounded">ส่งงาน</button>
        <button id="btn-cancel-submit" class="px-3 py-2 border rounded">ยกเลิก</button>
      </div>
    </div>
  `;
  root.appendChild(div);
  div.querySelector('#btn-cancel-submit').onclick = ()=> root.innerHTML = '';
  div.querySelector('#btn-send-submit').onclick = async () => {
    const fileInput = div.querySelector('#submit-file');
    const link = div.querySelector('#submit-link').value.trim();
    let fileData = null;
    if (fileInput.files.length > 0) {
      const f = fileInput.files[0];
      const b = await fileToBase64(f);
      fileData = {name: f.name, blob: b.split(',')[1]};
    }
    try {
      await api('submitTask', {id: taskId, file: fileData, link});
      showToast('ส่งงานเรียบร้อย');
      root.innerHTML = '';
      loadUserTasks(); loadSubmissions();
    } catch (e) { showToast('ผิดพลาด: '+e.message); }
  };
}

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function loadUserReport() {
  try {
    const res = await api('getReport', {scope:'user'});
    el('user-report').innerHTML = `
      <div>งานทั้งหมดของคุณ: <strong>${res.total || 0}</strong></div>
      <div>กำลังดำเนินการ: <strong>${res.inProgress || 0}</strong></div>
      <div>รอตรวจ: <strong>${res.submitted || 0}</strong></div>
      <div>อนุมัติแล้ว: <strong>${res.approved || 0}</strong></div>
    `;
  } catch (e) { /* ignore */ }
}

async function loadSubmissions() {
  try {
    const res = await api('getTasks', {scope:'submittedByMe'});
    const c = el('submissions-list'); c.innerHTML = '';
    res.tasks.forEach(t=>{
      const d = document.createElement('div');
      d.className = 'p-3 border rounded';
      d.innerHTML = `<div class="font-medium">${t.title}</div><div class="text-sm">${t.status} ${t.attachmentUrl ? `<a href="${t.attachmentUrl}" target="_blank" class="text-sky-600 underline">ไฟล์</a>`:''}</div>`;
      c.appendChild(d);
    });
  } catch (e) {}
}

/* ---------- Common: logout ---------- */
async function logout() {
  try {
    if (state.token) await api('logout');
  } catch(e){ /* ignore */ }
  state.token = null; state.user = null;
  localStorage.removeItem('task_app_token'); localStorage.removeItem('task_app_user');
  renderHeader();
  initLogin();
}

/* ---------- Init ---------- */
renderHeader();
initApp();
</script>
</body>
</html>
